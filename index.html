<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบแจ้งซ่อมคอมพิวเตอร์และอุปกรณ์</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    #root { min-height: 100vh; }
  </style>
</head>
<body>
  <div id="root">
    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; font-family: sans-serif; color: #666;">
      <div style="text-align: center;">
        <div style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <p>กำลังโหลดระบบ...</p>
      </div>
    </div>
  </div>

  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const AlertCircle = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
    );

    const Star = ({ className }) => (
      <svg className={className} fill="currentColor" stroke="currentColor" strokeWidth="0" viewBox="0 0 24 24">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
      </svg>
    );

    const Database = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
      </svg>
    );

    const Download = ({ className }) => (
      <svg className={className} fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    function RepairSystem() {
      const [currentView, setCurrentView] = useState('home');
      const [repairs, setRepairs] = useState([]);
      const [loading, setLoading] = useState(true);
      const [formData, setFormData] = useState({
        teacherName: '',
        department: '',
        phone: '',
        problemType: '',
        description: '',
        location: ''
      });
      const [ratingData, setRatingData] = useState({
        repairId: null,
        rating: 0,
        comment: '',
        technicianName: ''
      });

      useEffect(() => {
        loadRepairs();
      }, []);

      const loadRepairs = async () => {
        setLoading(true);
        try {
          const result = await window.storage.get('repairs-data', true);
          if (result && result.value) {
            const loadedRepairs = JSON.parse(result.value);
            setRepairs(loadedRepairs.sort((a, b) => b.id - a.id));
          }
        } catch (error) {
          console.log('ยังไม่มีข้อมูลในฐานข้อมูล');
        } finally {
          setLoading(false);
        }
      };

      const saveRepairs = async (updatedRepairs) => {
        try {
          await window.storage.set('repairs-data', JSON.stringify(updatedRepairs), true);
          setRepairs(updatedRepairs.sort((a, b) => b.id - a.id));
        } catch (error) {
          alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
          console.error(error);
        }
      };

      const handleInputChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };

      const handleSubmit = async () => {
        if (!formData.teacherName || !formData.department || !formData.phone || 
            !formData.problemType || !formData.description || !formData.location) {
          alert('กรุณากรอกข้อมูลให้ครบถ้วน');
          return;
        }

        const newRepair = {
          id: Date.now(),
          ...formData,
          status: 'รอดำเนินการ',
          createdAt: new Date().toLocaleString('th-TH'),
          rating: null
        };

        const updatedRepairs = [newRepair, ...repairs];
        await saveRepairs(updatedRepairs);
        
        setFormData({
          teacherName: '',
          department: '',
          phone: '',
          problemType: '',
          description: '',
          location: ''
        });
        
        alert('บันทึกการแจ้งซ่อมเรียบร้อยแล้ว');
        setCurrentView('list');
      };

      const updateRepairStatus = async (repairId, newStatus) => {
        const updatedRepairs = repairs.map(repair => {
          if (repair.id === repairId) {
            const updated = { ...repair, status: newStatus };
            if (newStatus === 'เสร็จสิ้น') {
              updated.completedAt = new Date().toLocaleString('th-TH');
            }
            return updated;
          }
          return repair;
        });
        await saveRepairs(updatedRepairs);
      };

      const handleRatingSubmit = async () => {
        if (ratingData.rating === 0) {
          alert('กรุณาให้คะแนน');
          return;
        }

        const updatedRepairs = repairs.map(repair => {
          if (repair.id === ratingData.repairId) {
            return {
              ...repair,
              rating: {
                score: ratingData.rating,
                comment: ratingData.comment,
                technicianName: ratingData.technicianName,
                ratedAt: new Date().toLocaleString('th-TH')
              }
            };
          }
          return repair;
        });

        await saveRepairs(updatedRepairs);
        setRatingData({ repairId: null, rating: 0, comment: '', technicianName: '' });
        alert('ขอบคุณสำหรับการให้คะแนนค่ะ');
        setCurrentView('list');
      };

      const startRating = (repair) => {
        setRatingData({
          repairId: repair.id,
          rating: 0,
          comment: '',
          technicianName: 'ฟลุ๊ก ศรัณย์ภัทร'
        });
        setCurrentView('rating');
      };

      const getStatusColor = (status) => {
        switch (status) {
          case 'รอดำเนินการ': return 'bg-yellow-100 text-yellow-800';
          case 'กำลังดำเนินการ': return 'bg-blue-100 text-blue-800';
          case 'เสร็จสิ้น': return 'bg-green-100 text-green-800';
          default: return 'bg-gray-100 text-gray-800';
        }
      };

      const exportToExcel = () => {
        if (repairs.length === 0) {
          alert('ไม่มีข้อมูลให้ Export');
          return;
        }

        // เตรียมข้อมูลสำหรับ Excel
        const excelData = repairs.map((repair, index) => ({
          'ลำดับ': index + 1,
          'ชื่อผู้แจ้ง': repair.teacherName,
          'หน่วยงาน': repair.department,
          'เบอร์โทร': repair.phone,
          'ประเภทปัญหา': repair.problemType,
          'สถานที่': repair.location,
          'รายละเอียดปัญหา': repair.description,
          'สถานะ': repair.status,
          'วันที่แจ้ง': repair.createdAt,
          'วันที่เสร็จสิ้น': repair.completedAt || '-',
          'ช่างผู้ซ่อม': repair.rating?.technicianName || '-',
          'คะแนนประเมิน': repair.rating ? `${repair.rating.score} ดาว` : '-',
          'ความคิดเห็น': repair.rating?.comment || '-'
        }));

        // สร้าง Workbook และ Worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(excelData);

        // ปรับความกว้างคอลัมน์
        const colWidths = [
          { wch: 8 },  // ลำดับ
          { wch: 20 }, // ชื่อผู้แจ้ง
          { wch: 20 }, // หน่วยงาน
          { wch: 15 }, // เบอร์โทร
          { wch: 20 }, // ประเภทปัญหา
          { wch: 20 }, // สถานที่
          { wch: 40 }, // รายละเอียดปัญหา
          { wch: 15 }, // สถานะ
          { wch: 20 }, // วันที่แจ้ง
          { wch: 20 }, // วันที่เสร็จสิ้น
          { wch: 20 }, // ช่างผู้ซ่อม
          { wch: 15 }, // คะแนนประเมิน
          { wch: 40 }  // ความคิดเห็น
        ];
        ws['!cols'] = colWidths;

        // เพิ่ม Worksheet เข้า Workbook
        XLSX.utils.book_append_sheet(wb, ws, 'รายการแจ้งซ่อม');

        // สร้างชื่อไฟล์ตามวันที่
        const date = new Date();
        const filename = `รายการแจ้งซ่อม_${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}.xlsx`;

        // ดาวน์โหลดไฟล์
        XLSX.writeFile(wb, filename);
        alert('ดาวน์โหลดไฟล์ Excel เรียบร้อยแล้ว');
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
          <div className="container mx-auto px-4 py-8 max-w-4xl">
            <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
              <div className="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <h1 className="text-3xl font-bold mb-2">ระบบแจ้งซ่อมคอมพิวเตอร์และอุปกรณ์</h1>
                    <p className="text-blue-100">สำหรับหน่วยงานราชการ</p>
                  </div>
                  <Database className="h-12 w-12 opacity-80" />
                </div>
                <div className="mt-3 flex items-center gap-2 text-sm text-blue-100">
                  <div className="h-2 w-2 bg-green-400 rounded-full animate-pulse"></div>
                  <span>เชื่อมต่อฐานข้อมูลแล้ว</span>
                </div>
              </div>

              <div className="flex border-b">
                <button
                  onClick={() => setCurrentView('home')}
                  className={`flex-1 py-3 px-4 font-medium transition-colors ${
                    currentView === 'home'
                      ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  แจ้งซ่อม
                </button>
                <button
                  onClick={() => setCurrentView('list')}
                  className={`flex-1 py-3 px-4 font-medium transition-colors ${
                    currentView === 'list'
                      ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600'
                      : 'text-gray-600 hover:bg-gray-50'
                  }`}
                >
                  รายการแจ้งซ่อม ({repairs.length})
                </button>
              </div>

              <div className="p-6">
                {loading ? (
                  <div className="text-center py-12">
                    <div className="inline-block h-8 w-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
                    <p className="mt-4 text-gray-600">กำลังโหลดข้อมูลจากฐานข้อมูล...</p>
                  </div>
                ) : (
                  <>
                    {currentView === 'home' && (
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            ชื่อ-นามสกุล ผู้แจ้ง <span className="text-red-500">*</span>
                          </label>
                          <input
                            type="text"
                            name="teacherName"
                            value={formData.teacherName}
                            onChange={handleInputChange}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ระบุชื่อ-นามสกุล"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            หน่วยงาน/แผนก <span className="text-red-500">*</span>
                          </label>
                          <input
                            type="text"
                            name="department"
                            value={formData.department}
                            onChange={handleInputChange}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ระบุหน่วยงาน/แผนก"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            เบอร์โทรศัพท์ <span className="text-red-500">*</span>
                          </label>
                          <input
                            type="tel"
                            name="phone"
                            value={formData.phone}
                            onChange={handleInputChange}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="0xx-xxx-xxxx"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            ประเภทปัญหา <span className="text-red-500">*</span>
                          </label>
                          <select
                            name="problemType"
                            value={formData.problemType}
                            onChange={handleInputChange}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          >
                            <option value="">เลือกประเภทปัญหา</option>
                            <option value="คอมพิวเตอร์">คอมพิวเตอร์</option>
                            <option value="เครื่องพิมพ์">เครื่องพิมพ์</option>
                            <option value="เครือข่าย/อินเทอร์เน็ต">เครือข่าย/อินเทอร์เน็ต</option>
                            <option value="โปรแกรม/ซอฟต์แวร์">โปรแกรม/ซอฟต์แวร์</option>
                            <option value="อุปกรณ์อื่นๆ">อุปกรณ์อื่นๆ</option>
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            สถานที่ <span className="text-red-500">*</span>
                          </label>
                          <input
                            type="text"
                            name="location"
                            value={formData.location}
                            onChange={handleInputChange}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ระบุสถานที่ เช่น อาคาร/ชั้น/ห้อง"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            รายละเอียดปัญหา <span className="text-red-500">*</span>
                          </label>
                          <textarea
                            name="description"
                            value={formData.description}
                            onChange={handleInputChange}
                            rows="4"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="อธิบายปัญหาที่พบโดยละเอียด"
                          />
                        </div>

                        <button
                          onClick={handleSubmit}
                          className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg"
                        >
                          ส่งแจ้งซ่อม
                        </button>
                      </div>
                    )}

                    {currentView === 'list' && (
                      <div className="space-y-4">
                        {repairs.length > 0 && (
                          <div className="flex justify-end mb-4">
                            <button
                              onClick={exportToExcel}
                              className="flex items-center gap-2 bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors shadow-md hover:shadow-lg"
                            >
                              <Download className="h-5 w-5" />
                              Export เป็น Excel
                            </button>
                          </div>
                        )}

                        {repairs.length === 0 ? (
                          <div className="text-center py-12 text-gray-500">
                            <AlertCircle className="mx-auto h-12 w-12 mb-4 opacity-50" />
                            <p>ยังไม่มีรายการแจ้งซ่อม</p>
                          </div>
                        ) : (
                          repairs.map((repair) => (
                            <div key={repair.id} className="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                              <div className="flex justify-between items-start mb-3">
                                <div>
                                  <h3 className="font-semibold text-lg text-gray-800">
                                    {repair.teacherName}
                                  </h3>
                                  <p className="text-sm text-gray-600">{repair.department}</p>
                                </div>
                                <span className={`px-3 py-1 rounded-full text-sm font-medium ${getStatusColor(repair.status)}`}>
                                  {repair.status}
                                </span>
                              </div>

                              <div className="grid md:grid-cols-2 gap-2 mb-3 text-sm">
                                <div className="text-gray-600">
                                  <span className="font-medium">ประเภท:</span> {repair.problemType}
                                </div>
                                <div className="text-gray-600">
                                  <span className="font-medium">เบอร์โทร:</span> {repair.phone}
                                </div>
                                <div className="text-gray-600">
                                  <span className="font-medium">สถานที่:</span> {repair.location}
                                </div>
                                <div className="text-gray-600">
                                  <span className="font-medium">แจ้งเมื่อ:</span> {repair.createdAt}
                                </div>
                              </div>

                              <div className="bg-white p-3 rounded border border-gray-200 mb-3">
                                <p className="text-sm text-gray-700">
                                  <span className="font-medium">ปัญหา:</span> {repair.description}
                                </p>
                              </div>

                              {repair.rating && (
                                <div className="bg-green-50 p-3 rounded border border-green-200 mb-3">
                                  <div className="flex items-center gap-2 mb-2">
                                    <span className="text-sm font-medium text-green-800">การประเมิน:</span>
                                    <div className="flex">
                                      {[1, 2, 3, 4, 5].map((star) => (
                                        <Star
                                          key={star}
                                          className={`h-4 w-4 ${
                                            star <= repair.rating.score
                                              ? 'fill-yellow-400 text-yellow-400'
                                              : 'text-gray-300'
                                          }`}
                                        />
                                      ))}
                                    </div>
                                  </div>
                                  {repair.rating.technicianName && (
                                    <p className="text-sm text-gray-700 mb-1">
                                      <span className="font-medium">ช่างผู้ซ่อม:</span> {repair.rating.technicianName}
                                    </p>
                                  )}
                                  {repair.rating.comment && (
                                    <p className="text-sm text-gray-700">
                                      <span className="font-medium">ความคิดเห็น:</span> {repair.rating.comment}
                                    </p>
                                  )}
                                </div>
                              )}

                              <div className="flex gap-2">
                                {repair.status === 'รอดำเนินการ' && (
                                  <button
                                    onClick={() => updateRepairStatus(repair.id, 'กำลังดำเนินการ')}
                                    className="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors text-sm"
                                  >
                                    เริ่มดำเนินการ
                                  </button>
                                )}
                                {repair.status === 'กำลังดำเนินการ' && (
                                  <button
                                    onClick={() => updateRepairStatus(repair.id, 'เสร็จสิ้น')}
                                    className="flex-1 bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600 transition-colors text-sm"
                                  >
                                    เสร็จสิ้น
                                  </button>
                                )}
                                {repair.status === 'เสร็จสิ้น' && !repair.rating && (
                                  <button
                                    onClick={() => startRating(repair)}
                                    className="flex-1 bg-yellow-500 text-white py-2 px-4 rounded hover:bg-yellow-600 transition-colors text-sm"
                                  >
                                    ประเมินการบริการ
                                  </button>
                                )}
                              </div>
                            </div>
                          ))
                        )}
                      </div>
                    )}

                    {currentView === 'rating' && (
                      <div className="space-y-6">
                        <div className="text-center">
                          <h2 className="text-2xl font-bold text-gray-800 mb-2">ประเมินการให้บริการ</h2>
                          <p className="text-gray-600">โปรดให้คะแนนความพึงพอใจในการให้บริการครั้งนี้</p>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            ชื่อช่างผู้ซ่อม
                          </label>
                          <input
                            type="text"
                            value={ratingData.technicianName}
                            onChange={(e) => setRatingData({...ratingData, technicianName: e.target.value})}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="ระบุชื่อช่างผู้ซ่อม"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-3 text-center">
                            ให้คะแนน <span className="text-red-500">*</span>
                          </label>
                          <div className="flex justify-center gap-2">
                            {[1, 2, 3, 4, 5].map((star) => (
                              <button
                                key={star}
                                type="button"
                                onClick={() => setRatingData({...ratingData, rating: star})}
                                className="transition-transform hover:scale-110"
                              >
                                <Star
                                  className={`h-12 w-12 ${
                                    star <= ratingData.rating
                                      ? 'fill-yellow-400 text-yellow-400'
                                      : 'text-gray-300 hover:text-yellow-200'
                                  }`}
                                />
                              </button>
                            ))}
                          </div>
                          {ratingData.rating > 0 && (
                            <p className="text-center mt-2 text-sm text-gray-600">
                              คุณให้คะแนน {ratingData.rating} ดาว
                            </p>
                          )}
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            ความคิดเห็นเพิ่มเติม
                          </label>
                          <textarea
                            value={ratingData.comment}
                            onChange={(e) => setRatingData({...ratingData, comment: e.target.value})}
                            rows="4"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="แสดงความคิดเห็นเกี่ยวกับการให้บริการ (ถ้ามี)"
                          />
                        </div>

                        <div className="flex gap-3">
                          <button
                            onClick={() => setCurrentView('list')}
                            className="flex-1 bg-gray-300 text-gray-700 py-3 px-6 rounded-lg font-medium hover:bg-gray-400 transition-colors"
                          >
                            ยกเลิก
                          </button>
                          <button
                            onClick={handleRatingSubmit}
                            disabled={ratingData.rating === 0}
                            className="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            ส่งการประเมิน
                          </button>
                        </div>
                      </div>
                    )}
                  </>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<RepairSystem />);
  </script>
</body>
</html>